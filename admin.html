<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración - Auditoría de Transferencias</title>
    <style>
        /* --- FUENTE Y BASE --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            margin: 0;
        }
        h2 { color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* --- CONTENEDORES --- */
        #login-form, #admin-panel {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 20px auto;
        }
        #login-form { max-width: 400px; }
        #admin-panel { max-width: 95%; }
        
        /* --- FORMULARIOS Y BOTONES --- */
        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 12px;
            margin: 8px 0 20px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { border-color: #1e88e5; outline: none; }

        button {
            background-color: #1e88e5;
            color: white;
            padding: 12px 20px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0d47a1; }
        
        /* Botón de Recargar/Filtro */
        #admin-panel button {
            width: auto;
            padding: 8px 15px;
            margin-left: 10px;
        }
        #statusFilter { width: auto; min-width: 150px; display: inline-block; margin-right: 20px;}
        
        /* --- MENSAJES --- */
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        #token-expiry { font-weight: bold; color: #ff9800; }

        /* --- TABLA DE AUDITORÍA --- */
        .table-container { 
            overflow-x: auto; 
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: separate; /* Permite border-radius */
            border-spacing: 0;
            min-width: 900px; /* Asegura el ancho mínimo */
        }
        table thead tr {
            background-color: #1e88e5;
            color: white;
        }
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        table td {
            background-color: #ffffff;
            font-size: 0.95em;
        }
        table tbody tr:hover td {
            background-color: #f9f9f9;
        }
        
        /* Colores de Estado */
        .status-PENDIENTE { color: #ff9800; font-weight: bold; }
        .status-COMPLETADA { color: #4caf50; font-weight: bold; }
        .status-RECHAZADA { color: #f44336; font-weight: bold; }

        /* Estilo para el Combobox de Acción */
        .action-select {
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
    </style>
</head>
<body>

    <h2>Panel de Administración de Transferencias</h2>
    <p id="message" class="error"></p>

    <div id="login-form">
        <h3>1. Iniciar Sesión</h3>
        <input type="text" id="username" placeholder="Usuario Admin" required>
        <input type="password" id="password" placeholder="Contraseña Admin" required>
        <button onclick="loginAdmin()">Ingresar</button>
        <p id="login-status"></p>
    </div>

    <div id="admin-panel" style="display:none;">
        <h3>2. Auditoría y Control de Transferencias</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <p style="margin:0;">Token expira en: <span id="token-expiry"></span></p>
            <div>
                <label for="statusFilter">Filtrar por Estado:</label>
                <select id="statusFilter" class="action-select" onchange="filterTransfers()">
                    <option value="TODAS">TODAS</option>
                    <option value="PENDIENTE" selected>PENDIENTE</option>
                    <option value="COMPLETADA">COMPLETADA</option>
                    <option value="RECHAZADA">RECHAZADA</option>
                </select>
                <button onclick="fetchAndRenderTransfers()">Recargar Datos</button>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente / DNI</th>
                        <th>Monto</th>
                        <th>Estado Actual</th>
                        <th>Comprobante</th>
                        <th>Fecha Reg.</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="transfer-table-body">
                    <tr><td colspan="7">Inicie sesión para ver las transferencias.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // La URL base de su API desplegada en Railway
        const API_BASE_URL = "https://backcurrency-api-production-64f5.up.railway.app";
        let adminToken = '';
        let tokenExpiryTimeout;
        let allTransfers = []; // Variable global para almacenar todos los datos

        // --- FUNCIONES ---

        // Función para obtener la lista COMPLETA de transferencias
        async function fetchAndRenderTransfers() {
            const tableBody = document.getElementById('transfer-table-body');
            tableBody.innerHTML = '<tr><td colspan="7">Cargando todas las transferencias...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/transfers/all`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    allTransfers = data.transfers; 
                    filterTransfers(); 
                } else {
                    tableBody.innerHTML = `<tr><td colspan="7" class="error">Fallo al cargar datos: ${data.message}</td></tr>`;
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="7" class="error">Error de red al cargar datos.</td></tr>';
                console.error('Error al cargar transferencias:', error);
            }
        }

        // Función que filtra y renderiza la tabla 
        function filterTransfers() {
            const status = document.getElementById('statusFilter').value;
            const tableBody = document.getElementById('transfer-table-body');
            tableBody.innerHTML = ''; 

            const filteredList = (status === 'TODAS') 
                ? allTransfers
                : allTransfers.filter(t => t.estado === status);

            if (filteredList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7">No hay transferencias con estado ${status}.</td></tr>`;
                return;
            }
            
            filteredList.forEach(transfer => {
                const row = tableBody.insertRow();
                
                row.insertCell(0).textContent = transfer.id;
                
                // Cliente / DNI
                row.insertCell(1).innerHTML = `<b>${transfer.nombre || 'N/A'}</b><br><small>DNI: ${transfer.dni || 'N/A'}</small>`;
                
                // Monto
                row.insertCell(2).textContent = `${transfer.moneda || 'S/.'} ${transfer.monto}`;
                
                // Estado Actual (Con clase CSS para color)
                const statusCell = row.insertCell(3);
                statusCell.textContent = transfer.estado;
                statusCell.className = `status-${transfer.estado}`; // Aplica PENDIENTE, COMPLETADA, etc.
                
                // Comprobante (Enlace)
                const comprobanteCell = row.insertCell(4);
                if (transfer.comprobante_url) {
                    comprobanteCell.innerHTML = `<a href="${transfer.comprobante_url}" target="_blank">Ver Comprobante</a>`;
                } else {
                    comprobanteCell.textContent = 'N/A';
                }
                
                // Fecha
                row.insertCell(5).textContent = new Date(transfer.fecha).toLocaleString(); 

                // Combobox de Acción (Muestra el estado actual)
                const actionCell = row.insertCell(6);
                const currentState = transfer.estado;
                
                actionCell.innerHTML = `
                    <select class="action-select" onchange="handleStatusChange(${transfer.id}, this.value)">
                        <option value="${currentState}" disabled selected>Estado: ${currentState}</option>
                        <option value="COMPLETADA">COMPLETADA</option>
                        <option value="RECHAZADA">RECHAZADA</option>
                        <option value="PENDIENTE">PENDIENTE</option>
                    </select>`;
            });
        }
        
        // Función que se dispara al cambiar el Combobox
        async function handleStatusChange(transferId, nuevoEstado) {
            if (!confirm(`¿Está seguro de cambiar la transferencia ID ${transferId} a ${nuevoEstado}?`)) {
                // Si el usuario cancela, recargar para que el select vuelva a su estado original
                fetchAndRenderTransfers();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/transfer/update`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}` 
                    },
                    body: JSON.stringify({ transferId, nuevoEstado })
                });
                
                const data = await response.json();

                if (data.success) {
                    alert(`Éxito: Transferencia ${transferId} marcada como ${nuevoEstado}.`);
                    // Recargar la lista completa para ver el cambio reflejado y aplicar el filtro
                    fetchAndRenderTransfers(); 
                } else {
                    alert(`Fallo al actualizar: ${data.message}`);
                }
            } catch (error) {
                alert("Error de red al intentar actualizar el estado.");
            }
        }
        
        // Función para el Login (Paso 1)
        async function loginAdmin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const statusElement = document.getElementById('login-status');

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    adminToken = data.token;
                    statusElement.className = 'success';
                    statusElement.textContent = `Éxito. Token obtenido.`;
                    
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';

                    const expiry = data.expires_in;
                    document.getElementById('token-expiry').textContent = expiry;

                    // Cargar datos después del login exitoso
                    fetchAndRenderTransfers();

                    // Temporizador de expiración de token (5 minutos)
                    const minutes = parseInt(expiry.replace('m', '')); 
                    clearTimeout(tokenExpiryTimeout);
                    tokenExpiryTimeout = setTimeout(() => {
                        alert("Token expirado. Por favor, inicie sesión de nuevo.");
                        window.location.reload(); 
                    }, minutes * 60 * 1000); 

                } else {
                    statusElement.className = 'error';
                    statusElement.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                statusElement.className = 'error';
                statusElement.textContent = `Error de conexión con la API.`;
                console.error('Error:', error);
            }
        }
    </script>

</body>
</html>